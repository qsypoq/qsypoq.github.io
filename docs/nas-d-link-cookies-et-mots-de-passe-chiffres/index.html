<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/png" href="/assets/favicon2.png"/>
    <title>NAS D-Link, cookies et mots de passe chiffrés</title>
    <link rel="stylesheet" type="text/css" href="/assets/css/custom.css" />
    <link rel="stylesheet" type="text/css" href="/assets/css/fork-awesome.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.28.0/prism.min.js" integrity="sha512-RDQSW3KoqJMiX0L/UBgwBmH1EmRYp8LBOiLaA8rBHIy+7OGP/7Gxg8vbt8wG4ZYd29P0Fnoq6+LOytCqx3cyoQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.28.0/plugins/autoloader/prism-autoloader.min.js" integrity="sha512-fTl/qcO1VgvKtOMApX2PdZzkziyr2stM65GYPLGuYMnuMm1z2JLJG6XVU7C/mR+E7xBUqCivykuhlzfqxXBXbg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet" type="text/css" href="/assets/css/github-markdown.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.28.0/themes/prism-okaidia.min.css" integrity="sha512-mIs9kKbaw6JZFfSuo+MovjU+Ntggfoj8RwAmJbVXQ5mkAX5LlgETQEweFPI18humSPHymTb5iikEOKWF7I8ncQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    </head>

<body class="post-template">
  <div class="site-wrapper">
    <header class="site-header outer">
      <div class="inner">
        <nav class="site-nav">
          <div class="site-nav-left">
            <a class="site-nav-logo" href="https://magnier.io"><img src="/assets/favicon2.png" alt="Vie de Nerd"></a>
            <ul class="nav">
              <li class="nav-current"><a href="https://magnier.io/">Hello, World_</a></li>
              <li><a href="/donate/">Donate</a></li>
              <li><a href="/contact/">Contact</a></li>
            </ul>
          </div>

          <div class="site-nav-right">
            <div class="social-links">

              <a class="social-link social-link-tw" href="https://twitter.com/qsypoq" title="Twitter" target="_blank" rel="noopener">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32">
                  <path d="M30.063 7.313c-.813 1.125-1.75 2.125-2.875 2.938v.75c0 1.563-.188 3.125-.688 4.625a15.088 15.088 0 0 1-2.063 4.438c-.875 1.438-2 2.688-3.25 3.813a15.015 15.015 0 0 1-4.625 2.563c-1.813.688-3.75 1-5.75 1-3.25 0-6.188-.875-8.875-2.625.438.063.875.125 1.375.125 2.688 0 5.063-.875 7.188-2.5-1.25 0-2.375-.375-3.375-1.125s-1.688-1.688-2.063-2.875c.438.063.813.125 1.125.125.5 0 1-.063 1.5-.25-1.313-.25-2.438-.938-3.313-1.938a5.673 5.673 0 0 1-1.313-3.688v-.063c.813.438 1.688.688 2.625.688a5.228 5.228 0 0 1-1.875-2c-.5-.875-.688-1.813-.688-2.75 0-1.063.25-2.063.75-2.938 1.438 1.75 3.188 3.188 5.25 4.25s4.313 1.688 6.688 1.813a5.579 5.579 0 0 1 1.5-5.438c1.125-1.125 2.5-1.688 4.125-1.688s3.063.625 4.188 1.813a11.48 11.48 0 0 0 3.688-1.375c-.438 1.375-1.313 2.438-2.563 3.188 1.125-.125 2.188-.438 3.313-.875z"></path>
                </svg>
              </a>

              <a class="social-link social-link-lk" href="https://www.linkedin.com/in/adam-magnier/" title="Linkedin" target="_blank" rel="noopener">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"></path></svg>
              </a>

              <a class="social-link social-link-gh" href="https://github.com/qsypoq" title="Github" target="_blank" rel="noopener">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>
              </a>
            </div>
          </div>
        </nav>
      </div>
    </header>

    <main id="site-main" class="site-main outer">
      <div class="inner">
        <article class="post-full post no-image">
          <figure class="post-full-image">
            <img srcset="medias/cookiesdlink.jpg 300w, medias/cookiesdlink.jpg 600w, medias/cookiesdlink.jpg 1000w, medias/cookiesdlink.jpg 2000w" sizes="(max-width: 800px) 400px, (max-width: 1170px) 1170px, 2000px" src="medias/cookiesdlink.jpg">
          </figure>
          <header class="post-full-header">
            <h1 class="post-full-title">NAS D-Link, cookies et mots de passe chiffrés</h1>
            <section class="post-full-meta">
              <time class="post-full-meta-date" datetime="2019-12-01">2019-12-01</time>
            </section>
            
          </header>
          <section class="post-full-content markdown-body">
            <hr/>
            <p>J’ai récemment mis la main sur un NAS D-Link, le <a href="https://eu.dlink.com/fr/fr/products/dns-325-sharecenter-2-bay-network-storage-enclosure">DNS-325</a>. Considéré comme « en fin de vie mais toujours supporté » mon premier réflexe a donc était de le mettre à jour.</p>
<p><img alt="La bête" src="medias/dbs325.png" /></p>
<p>Dernière MAJ disponible: fin 2013. Me voilà donc avec uniquement la v1 du SMB, pas de telnet ni de ssh. La seule interaction possible étant la webapp, on part de loin.</p>
<p>Voulant tester certaines idées d’interconnexions entre nagios et des équipements de mon réseau, dont le NAS, il me fallait un accès plus traditionnel sur la machine. C’est là que tout a commencé.</p>
<h2>Fun_Plug</h2>
<p>Les firmwares de certains NAS permettent l’exécution au boot d’un script nommé Fun_Plug. Contrairement aux autres fichiers systèmes ce dernier doit se situer sur le Volume_1 du disque dur et est donc accessible à l’utilisateur, lui permettant d’exécuter des commandes au démarrage du NAS.</p>
<p><img alt="" src="medias/ownit.jpg" /></p>
<p>C’est à ce moment qu’intervient Fonz, le développeur berlinois publie FFP ou Fonz Fun_Plug. Script qui permet de se servir de cette fonctionnalité afin de pimper le NAS avec quelques daemons bien pratiques tel que telnet, SSH ou encore rsync.</p>
<p>Au passage nous récupérons aussi l’accès root tant convoité…</p>
<h2>L’interface démoniaque</h2>
<p>Depuis le premier jour l’interface de connexion m’interpelle.</p>
<video controls>

    <source src="medias/logind325.mp4"
            type="video/mp4">

    Sorry, your browser doesn't support embedded videos.
</video>

<p>Il faut savoir que je n’enregistre pas les mots de passes de mon homelab dans mon navigateur mais que j’utilise les fonctions « se souvenir de moi » afin de rester connecter.</p>
<p>Sans même parler de son comportement étrange, l’autocomplétion du champ mot de passe m’intriguait donc.</p>
<h2>Cookies</h2>
<p>Afin de comprendre l’autocomplétion il faut faire un tour du côté des cookies, voici ce qu’on y trouve:</p>
<p><img alt="" src="medias/cookies.png" /></p>
<p>L’application pose donc 3 cookies:</p>
<ul>
<li>password: Stock une valeur qui semble chiffrée</li>
<li>uname: Le nom d’utilisateur entré, qu'il soit valide ou non.</li>
<li>rembMe: Si la case remember me est cochée. Dans le cas contraire alors les cookies uname et password sont supprimés.</li>
</ul>
<h2>Vous avez dit chiffré ?</h2>
<p>Le cookie password avait titillé ma curiosité et j’étais rendu root de la machine, mon setup de nagios pouvait attendre, il fallait que j’aille voir ce qui se passe du côté de la webapp…</p>
<p>Si nous regardons de plus près <strong>/var/www/web</strong> et son <strong>login.html</strong>, nous y retrouvons nos cookies précédents:</p>
<pre><code class="language-javascript">// set password
var cUName = $.cookie('uname');
var cPwd = $.cookie('password');

</code></pre>
<p>Ici l’app récupère nos cookies pour l’autocomplétion, mais ce qui m’intéresse c’est le pseudo-chiffrement effectué.</p>
<pre><code class="language-javascript">// Save checkbox, userName, password by cookie
$.cookie(&quot;rembMe&quot;, &quot;checked&quot;, { expires: 365 ,path: '/' });
$.cookie('uname', uName, { expires: 365 ,path: '/'});
$.cookie('password', encRC4(uName, pwd), { expires: 365 ,path: '/'});

</code></pre>
<p>Là ça devient intéressant, notre pass est donc chiffré par la fonction <strong>encRC4()</strong> qui prend comme argument notre nom d’utilisateur et notre mot de passe.</p>
<p>Aussi, qui dit chiffrement, qui déchiffrement:</p>
<pre><code class="language-javascript">$(&quot;#pre_pwd&quot;).click(function(){
        var cPwd = $.cookie('password');
        if (cPwd != '' &amp;&amp; cPwd != null) {
            $(&quot;#pre_pwd&quot;).val(decRC4($.cookie('uname'), $.cookie('password')));
            cPwd_tmp = cPwd;
            for (i=0;i&lt;16-cPwd.length;i++)
              cPwd_tmp = cPwd_tmp + &quot;*&quot;;

            //alert(cPwd.length);
            //alert(cPwd_tmp);
            $(&quot;#pre_pwd&quot;).val(cPwd_tmp);
        }
});

</code></pre>
<p>Voilà qui explique la danse du formulaire, on peut remarquer que c’est à ce moment que le pass est déchiffré du cookie, avec la fonction <strong>decRC4()</strong></p>
<p>Maintenant que nous avons une idée globale allons voir plus en detail le javascript. Qui a-t-il donc dans <strong>function/rc4.js</strong> ?</p>
<p>Tout d’abord la base de leur chiffrement:</p>
<pre><code class="language-javascript">function rc4(key, text) {
 var i, x, y, t, x2, kl=key.length;
 s=[];

 for (i=0; i&lt;256; i++) s[i]=i
 y=0
 x=kl; while(x--) {
  y=(key.charCodeAt(x) + s[x] + y) % 256
  t=s[x]; s[x]=s[y]; s[y]=t
 }
 x=0;  y=0;
 var z=&quot;&quot;
 for (x=0; x&lt;text.length; x++) {
  x2=x &amp; 255
  y=( s[x2] + y) &amp; 255
  t=s[x2]; s[x2]=s[y]; s[y]=t
  z+= String.fromCharCode((text.charCodeAt(x) ^ s[(s[x2] + s[y]) % 256]))
 }
 return z
}

</code></pre>
<p>Une adaptation de <a href="https://metacpan.org/pod/Crypt::RC4">crypt::rc4</a>, cohabitant avec de quoi faire des aller-retours en base64:</p>
<pre><code class="language-javascript">var tab = &quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&quot;

function textToBase64(t) {
 var r=''; var m=0; var a=0; var tl=t.length-1; var c
 for(n=0; n&lt;=tl; n++) {
  c=t.charCodeAt(n)
  r+=tab.charAt((c &lt;&lt; m | a) &amp; 63)
  a = c &gt;&gt; (6-m)
  m+=2
  if(m==6 || n==tl) {
   r+=tab.charAt(a)
//   if((n%45)==44) {r+=&quot;\n&quot;}
   m=0
   a=0
  }
 }
 return r
}

function base64ToText(t) {
 var r=''; var m=0; var a=0; var c
 for(n=0; n&lt;t.length; n++) {
  c=tab.indexOf(t.charAt(n))
  if(c &gt;= 0) {
   if(m) {
    r+=String.fromCharCode((c &lt;&lt; (8-m))&amp;255 | a)
   }
   a = c &gt;&gt; m
   m+=2
   if(m==8) { m=0 }
  }
 }
 return r
}

</code></pre>
<p>Mélangez un peu:</p>
<pre><code class="language-javascript">function encRC4(uName, pwd){
    return textToBase64(rc4(uName, pwd));
}

function decRC4(uName, pwd){
    return rc4(uName,base64ToText(pwd));
}

</code></pre>
<p>Et… c’est tout. Tout le système de chiffrement tient là.</p>
<p>Grace à la fonction decRC4, qui permet de repasser en clair le mot de passe contenu dans notre cookie, il n’y a même pas d’effort à faire et on crée un <strong><a href="https://random.magnier.io/dns-325-reverse/">outil de déchiffrement</a></strong> .</p>
<p>Il suffit alors de rentrer les informations contenues dans les cookies, le login ainsi que le mot de passe chiffré et le script nous retourne le mot de passe en clair.</p>
<p>On ne sait jamais, si besoin est de retrouver un mot de passe…</p>
          </section>

          <footer class="post-full-footer">
            <section class="author-card">
              <img class="author-profile-image" src="//www.gravatar.com/avatar/8952a5bcfd493bf24e7c8af50f6a28da?s=250&amp;d=mm&amp;r=x" alt="Adam 'Qsypoq' Magnier">
                <section class="author-card-content">
                  <h4 class="author-card-name"><a href="/">Adam 'Qsypoq' Magnier</a></h4>
                  <p>Read <a href="/">more posts</a> by this author.</p>
                </section>
            </section>
          </footer>
        </article>
      </div>
    </main>
  </div>

  <footer class="site-footer outer">
    <div class="site-footer-content inner">
      <section class="copyright"><a href="https://magnier.io"><img src="/assets/favicon.png" alt="Vie de Nerd" width="32" height="32"></a></section>
      <nav class="site-footer-nav">
        Powered by Persifleur <i style="color:#c0392b;" class="fa fa-heart"></i> <a href="https://magnier.io/mentions-legales">Mentions légales</a>.
      </nav>
    </div>
  </footer>
</body>
</html>