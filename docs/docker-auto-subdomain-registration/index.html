<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/png" href="/assets/favicon2.png"/>
    <title>Automatic subdomain registration for containers</title>
    <link rel="stylesheet" type="text/css" href="/assets/css/custom.css" />
    <link rel="stylesheet" type="text/css" href="/assets/css/fork-awesome.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.28.0/prism.min.js" integrity="sha512-RDQSW3KoqJMiX0L/UBgwBmH1EmRYp8LBOiLaA8rBHIy+7OGP/7Gxg8vbt8wG4ZYd29P0Fnoq6+LOytCqx3cyoQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.28.0/plugins/autoloader/prism-autoloader.min.js" integrity="sha512-fTl/qcO1VgvKtOMApX2PdZzkziyr2stM65GYPLGuYMnuMm1z2JLJG6XVU7C/mR+E7xBUqCivykuhlzfqxXBXbg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet" type="text/css" href="/assets/css/github-markdown.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.28.0/themes/prism-okaidia.min.css" integrity="sha512-mIs9kKbaw6JZFfSuo+MovjU+Ntggfoj8RwAmJbVXQ5mkAX5LlgETQEweFPI18humSPHymTb5iikEOKWF7I8ncQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    </head>

<body class="post-template">
  <div class="site-wrapper">
    <header class="site-header outer">
      <div class="inner">
        <nav class="site-nav">
          <div class="site-nav-left">
            <a class="site-nav-logo" href="https://magnier.io"><img src="/assets/favicon2.png" alt="Vie de Nerd"></a>
            <ul class="nav">
              <li class="nav-current"><a href="https://magnier.io/">Hello, World_</a></li>
              <li><a href="/donate/">Donate</a></li>
              <li><a href="/contact/">Contact</a></li>
            </ul>
          </div>

          <div class="site-nav-right">
            <div class="social-links">

              <a class="social-link social-link-tw" href="https://twitter.com/qsypoq" title="Twitter" target="_blank" rel="noopener">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32">
                  <path d="M30.063 7.313c-.813 1.125-1.75 2.125-2.875 2.938v.75c0 1.563-.188 3.125-.688 4.625a15.088 15.088 0 0 1-2.063 4.438c-.875 1.438-2 2.688-3.25 3.813a15.015 15.015 0 0 1-4.625 2.563c-1.813.688-3.75 1-5.75 1-3.25 0-6.188-.875-8.875-2.625.438.063.875.125 1.375.125 2.688 0 5.063-.875 7.188-2.5-1.25 0-2.375-.375-3.375-1.125s-1.688-1.688-2.063-2.875c.438.063.813.125 1.125.125.5 0 1-.063 1.5-.25-1.313-.25-2.438-.938-3.313-1.938a5.673 5.673 0 0 1-1.313-3.688v-.063c.813.438 1.688.688 2.625.688a5.228 5.228 0 0 1-1.875-2c-.5-.875-.688-1.813-.688-2.75 0-1.063.25-2.063.75-2.938 1.438 1.75 3.188 3.188 5.25 4.25s4.313 1.688 6.688 1.813a5.579 5.579 0 0 1 1.5-5.438c1.125-1.125 2.5-1.688 4.125-1.688s3.063.625 4.188 1.813a11.48 11.48 0 0 0 3.688-1.375c-.438 1.375-1.313 2.438-2.563 3.188 1.125-.125 2.188-.438 3.313-.875z"></path>
                </svg>
              </a>

              <a class="social-link social-link-lk" href="https://www.linkedin.com/in/adam-magnier/" title="Linkedin" target="_blank" rel="noopener">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"></path></svg>
              </a>

              <a class="social-link social-link-gh" href="https://github.com/qsypoq" title="Github" target="_blank" rel="noopener">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>
              </a>
            </div>
          </div>
        </nav>
      </div>
    </header>

    <main id="site-main" class="site-main outer">
      <div class="inner">
        <article class="post-full post no-image">
          <figure class="post-full-image">
            <img srcset="medias/docker-python-subdomain.jpg 300w, medias/docker-python-subdomain.jpg 600w, medias/docker-python-subdomain.jpg 1000w, medias/docker-python-subdomain.jpg 2000w" sizes="(max-width: 800px) 400px, (max-width: 1170px) 1170px, 2000px" src="medias/docker-python-subdomain.jpg">
          </figure>
          <header class="post-full-header">
            <h1 class="post-full-title">Automatic subdomain registration for containers</h1>
            <section class="post-full-meta">
              <time class="post-full-meta-date" datetime="2021-10-10">2021-10-10</time>
            </section>
            
          </header>
          <section class="post-full-content markdown-body">
            <hr/>
            <p>Since the migration of my blog and the surrounding infrastructure to docker in 2015 I'm a <a href="https://github.com/nginx-proxy/docker-gen">docker-gen</a> user, thanks to the <a href="https://github.com/nginx-proxy">nginx-proxy</a> stack.</p>
<p>Using nginx, docker-gen and acme-companion it generates reverse proxy configs &amp; manage the creation, renewal and use of SSL certificates for proxied Docker containers.</p>
<p>I always loved it because it really simplified my deployment, and after all these years I wanted to go on step further, and simplify it more, again.</p>
<p>When deploying another docker-compose project the only thing I needed to do manually was the subdomain registration in DNS. Which was annoying me because of how all over the place a virtual lab can be, like, did I already created this entry before ? Did I changed it ? And so on.</p>
<p>So I finally dug into docker-gen and how it works, seeking a way to do it without make it too complex and integrating well in this little ecosystem.</p>
<h2>How it works</h2>
<h3>Unix socket</h3>
<p><img alt="Spoiler" src="medias/docker-arch.png" /></p>
<p>The docker daemon is listening to <code>/var/run/docker.sock</code> which is docker's UNIX socket. It's the main entry point for Docker API. This is what docker-gen use to be aware of what's going on in our little containerized world.</p>
<p>Using the same technique we will listen to it and its events, enabling us to know when containers are started, stopped and other information about them.</p>
<p>Fortunately we have a <a href="https://docker-py.readthedocs.io/en/stable/">python library</a> for the docker engine API, we can use it like this:</p>
<pre><code class="language-python">#!/usr/local/bin/python3.9
import docker

client = docker.from_env()
events = client.events(decode=True)

for event in events:
  if event['Action'] == 'start':
    ### Do stuff
</code></pre>
<p>Simple stuff right ? In this example we listen for container events, and can <code>do stuff</code> whenever one of them start.</p>
<p>We can schematize our goal like this:</p>
<ul>
<li>Listen event from the docker's UNIX socket</li>
<li>When a container is started, check if the needed environment variables are set</li>
<li>Call the registrar script with these arguments</li>
<li>Make call to the right registrar's API and update the DNS entries.</li>
</ul>
<p>I've done it like this:</p>
<pre><code class="language-python">#!/usr/local/bin/python3.9
import docker
import os

client = docker.from_env()
events = client.events(decode=True)

for event in events:
  if event['Action'] == 'start':
    container = client.containers.get(event['id'])
    container_envs = container.attrs['Config']['Env']
    fqdn_list = registrar = external_ip = None
    for env in container_envs:
      if env.find('VIRTUAL_HOST') &gt; -1:
        fqdn_list = env.split(&quot;=&quot;, 1)[-1]
        fqdn_list = fqdn_list.split(',')
      if env.find('REGISTRAR') &gt; -1:
        registrar = env.split(&quot;=&quot;, 1)[-1]
      if env.find('EXTERNAL_IP') &gt; -1:
        external_ip = env.split(&quot;=&quot;, 1)[-1]
    if fqdn_list and registrar and external_ip:
      for fqdn in fqdn_list:
        os.system(f&quot;cd /usr/src/app &amp;&amp; python register.py {fqdn.strip()} {registrar} {external_ip}&quot;)
</code></pre>
<p>With this method we check, for every starting container, if it contains the environment variables we are waiting:</p>
<ul>
<li><code>VIRTUAL_HOST</code>: List of subdomains to register</li>
<li><code>REGISTRAR</code>: The target registrar</li>
<li><code>EXTERNAL_IP</code>: The target IP to register in ours DNS entries</li>
</ul>
<h2>Registrar API</h2>
<h3>Python lib</h3>
<p>Now that we can read docker events we need to be able to exploit them. Fortunately my registrar have an API available, so this is only a matter of time between it, python and me.</p>
<p>As I only own domains on 1 registrar the project is, for now, only compatible with Namecheap. Feel free to join the project <a href="https://github.com/qsypoq/subdomain-auto-registration">on GitHub</a> or contact me if you want to participate &amp; see more choices available.</p>
<p>So, I forked <a href="https://github.com/Bemmu/PyNamecheap">PyNamecheap</a> which isn't maintained anymore, merged waiting PRs and stripped unnecessary functions to keep it as simple as possible.</p>
<p>Then added my own function to check, compare and update the SLDs from environment arguments:</p>
<pre><code class="language-python">def check_sld(self, fqdn, target_ip):
    sld, tld = fqdn.split(&quot;.&quot;, 1)
    hosts = self.domains_dns_getHosts(tld)
    for host in hosts:
        if host['Type'] == 'A':
            if host['Name'] == sld:
                if host['Address'] == target_ip:
                    print(f&quot;{fqdn} is already registered to {host['Address']}&quot;)
                    return
                else:
                    print(f&quot;{fqdn} is already registered to {host['Address']} instead of {target_ip}, deleting...&quot;)
                    self.domains_dns_delHost(tld, {
                        &quot;RecordType&quot;: &quot;A&quot;,
                        &quot;HostName&quot;: sld,
                        &quot;Address&quot;: {host['Address']}
                    })
    self.domains_dns_addHost(tld, {
        &quot;RecordType&quot;: &quot;A&quot;,
        &quot;HostName&quot;: sld,
        &quot;Address&quot;: target_ip,
        &quot;MXPref&quot;: 10, #Default value
        &quot;TTL&quot;: 1799 #Value for Automatic TTL
    })
    print(f&quot;{fqdn} is now registered to {target_ip}&quot;)
    return 
</code></pre>
<p>Now I have my own module which can be used in the project !</p>
<h3>Configuration management</h3>
<p>I'm using <a href="https://confuse.readthedocs.io/en/latest/">confuse</a> to manage the configuration files containing the required information to interact with the registrar's API.</p>
<p>In namecheap's case we need:</p>
<ul>
<li>account's username</li>
<li>API key</li>
<li>whitelisted's IP authorized to use the API key</li>
</ul>
<p>Put them in a YAML file and call it a day. The final idea of this is to have a conf folder, where we put all ours <code>registrar-name.yml</code>, making possible to work in a multi-registrar environment.</p>
<h3>Mix them together</h3>
<p>The final registrar script:</p>
<pre><code class="language-python">#!/usr/local/bin/python3.9
import sys
sys.path.append('./lib')
from namecheap import Api
import confuse

config = confuse.Configuration('subdomain-auto-registrar', __name__)

fqdn = sys.argv[1]
registrar = sys.argv[2]
external_ip = sys.argv[3]

config.set_file(f&quot;conf/{registrar.lower()}.yml&quot;)

if registrar.lower() == 'namecheap':
  api = Api(config['username'].get(str), config['api_key'].get(str), config['username'].get(str), config['whitelisted_ip'].get(str))
  api.check_sld(fqdn, external_ip)
</code></pre>
<p>Doing like this we check the registrar name, then we load the correct configuration file and make the right API calls.</p>
<p>Having the registrar's name as an environment variable really help us to make these calls. We can even imagine homemade DNS manager in organization using this for local update, it just needs a dedicated lib with the right API calls, like any other registrar.</p>
<p>To-do: </p>
<ul>
<li>Handling bad configuration and trigger an error message when the configuration is missing an element.</li>
<li>Handling more registrar, having more module or calling already existing ones.</li>
</ul>
<h2>Demonstration</h2>
<p>With everything set up we now have to start the listener, and wait for container to trigger the registration's process.</p>
<p>Demo's docker-compose file:</p>
<pre><code class="language-yaml">version: '3.1'

services:
  web:
    image: php:7.4-apache
    container_name: efficom_apache_web
    restart: always
    ports:
      - 8082:80
    environment:
      VIRTUAL_HOST: efficom.magnier.io
      VIRTUAL_PORT: 8082
      LETSENCRYPT_HOST: efficom.magnier.io
      LETSENCRYPT_EMAIL: mycertemail@tld.io
      REGISTRAR: namecheap
      EXTERNAL_IP: 152.228.170.93
    volumes:
      - ./content:/var/www/html

networks:
   default:
     external:
       name: nginx-proxy
</code></pre>
<p>Once the listener is active your A entry will be automatically updated when a container is started.</p>
<p>After deploying a newly configured env we can see it in our container's log output:</p>
<p><img alt="Spoiler" src="medias/console_log.jpg" /></p>
<p>Seconds after the containers are up and running, we can see the new entries on the DNS dashboard:</p>
<p><img alt="Spoiler" src="medias/namecheap_dashboard.jpg" /></p>
<h2>Final word</h2>
<p>This was fun, I'm glad to now have another piece of my personal infrastructure automatized and I hope you find this post instructive.</p>
<p>The project and its source code are <a href="https://github.com/qsypoq/subdomain-auto-registration">available on GitHub</a>. Don't hesitate to contribute to it !</p>
          </section>

          <footer class="post-full-footer">
            <section class="author-card">
              <img class="author-profile-image" src="//www.gravatar.com/avatar/8952a5bcfd493bf24e7c8af50f6a28da?s=250&amp;d=mm&amp;r=x" alt="Adam 'Qsypoq' Magnier">
                <section class="author-card-content">
                  <h4 class="author-card-name"><a href="/">Adam 'Qsypoq' Magnier</a></h4>
                  <p>Read <a href="/">more posts</a> by this author.</p>
                </section>
            </section>
          </footer>
        </article>
      </div>
    </main>
  </div>

  <footer class="site-footer outer">
    <div class="site-footer-content inner">
      <section class="copyright"><a href="https://magnier.io"><img src="/assets/favicon.png" alt="Vie de Nerd" width="32" height="32"></a></section>
      <nav class="site-footer-nav">
        Powered by Persifleur <i style="color:#c0392b;" class="fa fa-heart"></i> <a href="https://magnier.io/mentions-legales">Mentions légales</a>.
      </nav>
    </div>
  </footer>
</body>
</html>